name: Auto-Update Checksums

# This workflow automatically updates checksum files whenever apr or install.sh
# changes on main. This prevents the installer from failing due to checksum
# mismatches.

on:
  push:
    branches: [main]
    paths:
      - 'apr'
      - 'install.sh'

permissions:
  contents: write

jobs:
  update-checksums:
    name: Update Checksums
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # Fetch with depth 2 to allow diffing
          fetch-depth: 2

      - name: Check if checksum update needed
        id: check
        run: |
          set -euo pipefail

          # Calculate current checksums
          apr_hash=$(sha256sum apr | awk '{print $1}')
          install_hash=$(sha256sum install.sh | awk '{print $1}')

          # Read stored checksums
          stored_apr_hash=$(cat apr.sha256 2>/dev/null | awk '{print $1}' | tr -d '[:space:]' || echo "")
          stored_install_hash=$(cat install.sh.sha256 2>/dev/null | awk '{print $1}' | tr -d '[:space:]' || echo "")

          echo "Current apr hash:      $apr_hash"
          echo "Stored apr hash:       $stored_apr_hash"
          echo "Current install hash:  $install_hash"
          echo "Stored install hash:   $stored_install_hash"

          if [[ "$apr_hash" != "$stored_apr_hash" ]] || [[ "$install_hash" != "$stored_install_hash" ]]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "::notice::Checksum files need updating"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Checksums are already up to date"
          fi

      - name: Update checksum files
        if: steps.check.outputs.needs_update == 'true'
        run: |
          set -euo pipefail

          # Generate individual checksum files (hash only)
          sha256sum apr | awk '{print $1}' > apr.sha256
          sha256sum install.sh | awk '{print $1}' > install.sh.sha256

          # Generate combined checksum files
          sha256sum apr install.sh > checksums.txt
          sha256sum apr install.sh > CHECKSUMS.sha256

          echo "Updated checksums:"
          echo "  apr:        $(cat apr.sha256)"
          echo "  install.sh: $(cat install.sh.sha256)"

      - name: Commit and push
        if: steps.check.outputs.needs_update == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add apr.sha256 install.sh.sha256 checksums.txt CHECKSUMS.sha256

          # Check if there are actually changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit (files already staged elsewhere)"
            exit 0
          fi

          git commit -m "chore(auto): update checksums for apr/install.sh changes

          This commit was automatically generated by the auto-checksum workflow
          to keep checksum files in sync with script changes.

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          # Push with retry logic
          for i in 1 2 3; do
            if git push; then
              echo "::notice::Checksums updated and pushed successfully"
              exit 0
            fi
            echo "Push attempt $i failed, retrying..."
            git pull --rebase
            sleep 2
          done

          echo "::error::Failed to push checksum updates after 3 attempts"
          exit 1
