name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: ShellCheck & Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck on apr
        run: shellcheck apr

      - name: Run ShellCheck on install.sh
        run: shellcheck install.sh

      - name: Check bash syntax (apr)
        run: bash -n apr

      - name: Check bash syntax (install.sh)
        run: bash -n install.sh

      - name: Verify apr --version works
        run: |
          chmod +x apr
          ./apr --version

      - name: Verify VERSION file consistency
        run: |
          chmod +x apr
          APR_VERSION=$(./apr --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
          if [[ "$APR_VERSION" != "$FILE_VERSION" ]]; then
            echo "Version mismatch!"
            echo "  apr --version: $APR_VERSION"
            echo "  VERSION file:  $FILE_VERSION"
            exit 1
          fi
          echo "Versions match: $APR_VERSION"

  dry-run:
    name: Dry Run Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create mock workflow
        run: |
          mkdir -p .apr/workflows .apr/rounds/test
          cat > .apr/workflows/test.yaml << 'EOF'
          name: test
          description: Test workflow
          documents:
            readme: README.md
            spec: AGENTS.md
          oracle:
            model: "5.2 Thinking"
          rounds:
            output_dir: .apr/rounds/test
          EOF
          cat > .apr/config.yaml << 'EOF'
          default_workflow: test
          EOF

      - name: Test apr --help
        run: |
          chmod +x apr
          ./apr --help

      - name: Test apr list
        run: |
          chmod +x apr
          ./apr list

      - name: Test apr run --dry-run (without Oracle)
        run: |
          chmod +x apr
          # Create a mock oracle script
          mkdir -p /tmp/mock-bin
          cat > /tmp/mock-bin/oracle << 'MOCK'
          #!/bin/bash
          echo "Mock Oracle"
          MOCK
          chmod +x /tmp/mock-bin/oracle
          export PATH="/tmp/mock-bin:$PATH"

          # Dry run should work with mock
          ./apr run 1 --dry-run 2>&1 | tee output.txt
          grep -q "Would execute" output.txt && echo "Dry run works!"

  install-test:
    name: Installer Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test installer syntax
        run: |
          bash -n install.sh
          shellcheck install.sh

      - name: Test installer (local file simulation)
        run: |
          # Create a test environment
          export HOME=$(mktemp -d)
          export APR_NO_DEPS=1

          # Modify installer to use local file instead of downloading
          sed 's|download_file "$download_url" "$tmp_file"|cp apr "$tmp_file"|g' install.sh > /tmp/test_install.sh

          # Run installer
          bash /tmp/test_install.sh

          # Verify installation
          if [[ -x "$HOME/.local/bin/apr" ]]; then
            echo "Installation successful!"
            "$HOME/.local/bin/apr" --version
          else
            echo "Installation failed"
            exit 1
          fi
