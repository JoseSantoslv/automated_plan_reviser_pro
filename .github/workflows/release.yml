name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate tag matches VERSION file
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
          if [[ "$TAG_VERSION" != "$FILE_VERSION" ]]; then
            echo "Tag version ($TAG_VERSION) doesn't match VERSION file ($FILE_VERSION)"
            exit 1
          fi
          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Run ShellCheck
        run: |
          sudo apt-get install -y shellcheck
          shellcheck apr install.sh

      - name: Generate checksums
        run: |
          sha256sum apr > apr.sha256
          sha256sum install.sh > install.sh.sha256
          echo "APR checksum: $(cat apr.sha256)"
          echo "Installer checksum: $(cat install.sh.sha256)"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: APR v${{ env.VERSION }}
          body: |
            ## Automated Plan Reviser Pro v${{ env.VERSION }}

            ### Installation

            **Quick install (recommended):**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            **Install specific version:**
            ```bash
            APR_VERSION=${{ env.VERSION }} curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            **Manual download:**
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/apr -o apr
            chmod +x apr
            ```

            ### Checksums

            Verify your download:
            ```bash
            # For apr script
            sha256sum -c apr.sha256

            # For installer
            sha256sum -c install.sh.sha256
            ```

            ### What's New

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

          files: |
            apr
            install.sh
            apr.sha256
            install.sh.sha256
            VERSION
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-checksums:
    name: Update Main Branch Checksums
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate and commit checksums
        run: |
          sha256sum apr | cut -d' ' -f1 > apr.sha256
          sha256sum install.sh | cut -d' ' -f1 > install.sh.sha256

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet apr.sha256 install.sh.sha256 2>/dev/null; then
            echo "Checksums unchanged"
          else
            git add apr.sha256 install.sh.sha256
            git commit -m "chore: update checksums for v${GITHUB_REF#refs/tags/v}"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
